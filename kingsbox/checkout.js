const translate = {
    en: {
        shop: 'Shop',
        shipping: 'Shipping info',
        delivery: 'Delivery Method',
        payment: 'payment',
        total: 'Your cart total is',
        summary: 'Summary',
        backShop: 'back to shop',
        continueDelivery: 'continue to delivery',
        backShipping: 'Back to Shipping info',
        continuePayment: 'continue to Payment',
        backDelivery: 'Back to delivery method',
        pay: 'Pay now',
        change: 'Change',
        calculated: 'Calculated at next step',
        guaranteeTitle: '30 days money back guarantee',
        guaranteeBody: `If you are not satisfied with your Kingsbox product,
        you can return it within 30 days 
        of delivery without giving a specific reason for return.`,
    },
    it: {
        shop: 'Negozio',
        shipping: 'Informazioni sulla spedizione',
        delivery: 'Modalità di consegna',
        payment: 'Pagamento',
        total: 'Il totale del tuo carrello è',
        summary: 'Sommario',
        backShop: 'Torna al negozio',
        continueDelivery: 'continuare con la spedizione',
        backShipping: 'Torna alle informazioni sulla spedizione',
        continuePayment: 'continua con il pagamento',
        backDelivery: 'Torna alla modalità di consegna',
        pay: 'Paga ora',
        change: 'Modifica',
        calculated: 'Si calcola al passo successivo',
        guaranteeTitle: '30 giorni di garanzia sul rimborso',
        guaranteeBody: `Se non sei soddisfatto del tuo prodotto Kingsbox,
        puoi restituirlo entro 30 giorni dalla 
        dalla consegna, senza fornire un motivo specifico per la restituzione.`,
    },
    hr: {
        shop: 'Trgovina',
        shipping: 'Podaci za dostavu',
        delivery: 'Način dostave',
        payment: 'Plaćanje',
        total: 'Vaš ukupni iznos košarice je',
        summary: 'Pregled',
        backShop: 'Povratak u trgovinu',
        continueDelivery: 'nastavi na dostavu',
        backShipping: 'Povratak na podatke za dostavu',
        continuePayment: 'nastavi s plaćanjem',
        backDelivery: 'Povratak na način dostave',
        pay: 'Platite odmah',
        change: 'Promijeni',
        calculated: 'Izračunat će se u sljedećem koraku',
        guaranteeTitle: '30 dana jamstva povrata novca',
        guaranteeBody:
            'Ako niste zadovoljni svojim proizvodom Kingsbox, možete ga vratiti u roku od 30 dana od dostave bez navođenja razloga za povrat.',
    },
    sl: {
        shop: 'Nakupuj',
        shipping: 'Podatki o dostavi',
        delivery: 'Način dostave',
        payment: 'Plačilo',
        total: 'Skupen znesek nakupa je',
        summary: 'Povzetek',
        backShop: 'Nazaj v trgovino',
        continueDelivery: 'Nadaljuj na dostavo',
        backShipping: 'Nazaj na podatke o dostavi',
        continuePayment: 'Nadaljuj s plačilom',
        backDelivery: 'Nazaj na načine dostave',
        pay: 'Plačaj zdaj',
        change: 'Spremeni',
        calculated: 'Izračunano na naslednjem koraku',
        guaranteeTitle: '30 dnevno jamstvo vračila denarja',
        guaranteeBody: 'Če niste zadovoljni s KingsBox izdelkom, ga lahko v 30 dneh vrnete brez navedenega razloga.',
    },
    de: {
        shop: 'Shop',
        shipping: 'Versandinformation',
        delivery: 'Liefermethode',
        payment: 'Zahlung',
        total: 'Ihr Einkaufswagen insgesamt ist',
        summary: 'Zusammenfassung',
        backShop: 'Zurück zum Shop',
        continueDelivery: 'weiter zur Lieferung',
        backShipping: 'Zurück zu den Versandinformationen',
        continuePayment: 'weiter zur Zahlung',
        backDelivery: 'Zurück zur Liefermethode',
        pay: 'Zahlen Sie jetzt',
        change: 'Veränderung',
        calculated: 'Wird im nächsten Schritt berechnet',
        guaranteeTitle: '30 Tage Geld-zurück-Garantie',
        guaranteeBody: `Wenn Sie mit Ihrem Kingsbox-Produkt nicht zufrieden sind,
        können Sie es innerhalb von 30 Tagen der Lieferung zurück geben ohne Angabe eines bestimmten Rücksendegrundes.`,
    },
    fr: {
        shop: 'Boutique',
        shipping: 'Information de livraison',
        delivery: 'Mode de livraison',
        payment: 'Paiement',
        total: 'Le montant de votre panier est',
        summary: 'Le sommaire',
        backShop: 'Retour à la boutique',
        continueDelivery: 'continuer vers la livraison',
        backShipping: "Retour à l'expédition",
        continuePayment: 'passer au paiement',
        backDelivery: 'Retour à la mode de livraison',
        pay: 'Payer maintenant',
        change: 'Changements',
        calculated: "Calculé à l'étape suivante",
        guaranteeTitle: 'Remboursement garanti pendant 30 jours',
        guaranteeBody: `Si vous n'êtes pas satisfait de votre produit Kingsbox,
        vous pouvez le retourner dans les 30 jours 
        à partir de la livraison sans indiquer la raison spécifique pour le retour.`,
    },
    es: {
        shop: 'Comprar',
        shipping: 'Información de envío',
        delivery: 'Forma de entrega',
        payment: 'Pago',
        total: 'El total de tu carrito es',
        summary: 'Resumen',
        backShop: 'Volver a la Tienda',
        continueDelivery: 'continuar con el Envío',
        backShipping: 'Volver a la Información de Envío',
        continuePayment: 'continuar con Pago',
        backDelivery: 'Volver a la forma de entrega',
        pay: 'Pagar ahora',
        change: 'Cambiar',
        calculated: 'Calculado en el siguiente paso',
        guaranteeTitle: '30 días de garantía de devolución del dinero',
        guaranteeBody: `Si no estás satisfecho con tu producto Kingsbox
        puedes devolverlo en un plazo de 30 días 
        de la entrega sin dar una razón específica para la devolución.`,
    },
    nl: {
        // dutch
        shop: 'Winkel',
        shipping: 'Verzendinfo',
        delivery: 'Levering',
        payment: 'Betaling',
        total: 'Het totaal van uw winkelwagen is',        
        summary: 'Samenvatting',
        backShop: 'Terug naar de winkel',
        continueDelivery: 'verder naar levering',
        backShipping: 'Terug naar Verzendinfo',
        continuePayment: 'verder naar Betaling',
        backDelivery: 'Terug naar leveringsmethode',
        pay: 'Betaal nu',
        change: 'Wijzig',
        calculated: 'Berekend bij de volgende stap',
        guaranteeTitle: '30 dagen geld terug garantie',
        guaranteeBody: `Als u niet tevreden bent met uw Kingsbox product, kunt u het binnen 30 dagen na levering zonder een specifieke reden op te geven.`,
    },
    se: {
        // svenska
        shop: 'Butik',
        shipping: 'Fraktinformation',
        delivery: 'Leveransmetod',
        payment: 'Betalning',
        total: 'Din summa i varukorgen är',
        summary: 'Sammanfattning',
        backShop: 'Tillbaka till butiken',
        continueDelivery: 'Fortsätt till leverans',
        backShipping: 'Tillbaka till fraktinformation',
        continuePayment: 'Fortsätt till betalning',
        backDelivery: 'Tillbaka till leveranssätt',
        pay: 'Betala nu',
        change: 'Byt / Ändra',
        calculated: 'Beräknas vid nästa steg',
        guaranteeTitle: '30-dagars återbetalningsgaranti',
        guaranteeBody:
            'Om du inte är nöjd med din Kingsbox-produkt kan du returnera den inom 30 dagar efter leverans utan att ange ett specifikt skäl för returen.',
    },
    cs: {
        // Czech
        shop: 'Obchod',
        shipping: 'Informace o přepravě',
        delivery: 'Způsob doručení',
        payment: 'Platba',
        total: 'V košíku je celkem',
        summary: 'Souhrn',
        backShop: 'Zpět do obchodu',
        continueDelivery: 'pokračovat k dodávce',
        backShipping: 'Zpět na informace o přepravě',
        continuePayment: 'Pokračovat v platbě',
        backDelivery: 'Zpět na způsob doručení',
        pay: 'Zaplatit nyní',
        change: 'Změnit',
        calculated: 'Vypočte se v následujícím kroku',
        guaranteeTitle: '30denní záruka vrácení peněz',
        guaranteeBody: `Pokud nejste s produktem od Kingsboxu spokojeni,
        můžete jej do 30 dnů od doručení vrátit bez udání konkrétního důvodu pro vrácení.`,
    },
};

let language = location.pathname.split('/')[1];
language === 'checkout' ? (language = 'en') : language;
const lang = translate[language];

const style = /*html*/ `
        <style>
            .container.container-checkout {
                padding-bottom: 30px;
            }
            #notification-container + div > div {
                left: 20px !important;
                right: auto;
                width: fit-content;
            }
            .i-embedded-form {
                left: 0 !important;
                right: auto !important;
            }
            .logo-wrapper {pointer-events: none;}

            .steps {
                display: flex;
                flex-direction: row;
                align-items: center;
                max-width: 530px;
                margin: 40px 0 55px;
            }
            .step {
                position: relative;
            }
            .step p {
                margin: 4px 0 0;
                text-align: center;
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                text-transform: uppercase;
                color: #A1A1A1;
            }
            .circle {
                position: relative;
                width: 50px;
                height: 50px;
                border: 2px solid #A1A1A1;
                border-radius: 50%;
            }
            .circle::after {
                content: attr(data-number);
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-weight: 600;
                font-size: 16px;
                color: #A1A1A1;
            }
            .check .circle::after {
                content: url('https://conversionratestore.github.io/projects/kingsbox/img/check_arr.svg');
            }
            .line {
                height: 2px;
                width: 100%;
                background-color: #A1A1A1;
            }
            .black .circle,
            .check .circle {
                border-color: #212529;
            }
            .black .circle::after,
            .check .circle::after {
                color: #212529;
            }
            .black + .line,
            .check + .line {
                background-color: #212529;
            }
            .black.step p,
            .check.step p {
                color: #212529;
            }

            .checkout-shipping {
                padding-right: 48px;
                background-color: #fff;
            }

            .checkout-shipping-info {
                padding-left: 0 !important;
                padding-right: 0 !important;
            }

            /* app-checkout-shipping-info,
            app-checkout-delivery-method,
            app-checkout-payment, */
            app-checkout-notes {
                display: none;
            } 

            .checkout-shopping-cart {
                padding: 0 !important;
            }

            .checkout-shopping-cart div {
                background-color: #f4f4f4;
            }

            .checkout-shopping-cart hr {
                display: none !important;
            }

            .moneyback {
                background: #28A9E2 !important;
                padding: 20px 40px;
                text-align: center;
            }
            .moneyback p {
                line-height: 171.19%;
                color: #FFFFFF;
                margin: 0;
            }        
            .moneyback p:first-child {
                font-weight: 600;
                font-size: 16px;
                text-transform: uppercase;
            }
            .moneyback p:last-child {
                font-weight: 400;
                font-size: 12px;
            }

            .my_title {
                font-weight: 600;
                font-size: 25px;
                line-height: 31px;
                color: #212529;
                margin-bottom: 30px;
            }

            app-checkout-shopping-cart .card-title-wrapper {display: none !important;}

            .checkout-summary,
            .checkout-shopping-cart {
                border-top: none;
            }

            .checkout-summary .card-title-wrapper,
            .checkout-summary .products,
            .checkout-summary .checkout-submit {
                display: none !important;
            }

            .shopping-cart-product {
                padding: 30px;
                background-color: #f4f4f4;
            }

            .checkout-summary .coupons-form {
                margin-top: 0 !important;
            }

            .coupons-form div:first-child p {
                text-decoration: underline;
                cursor: pointer;
            }

            .coupons-form div:last-child {
                height: 0;
                opacity: 0;
                transition: 0.7s all ease;
                pointer-events: none;
            }

            .coupons-form.opened div:last-child {
                height: 45px;
                opacity: 1;
                pointer-events: auto;
            }

            .steps_btn_wrapper div {
                display: flex;
                flex-direction: row;
                justify-content: space-between;
                margin-top: 10px;
            }

            .steps_btn_wrapper button {
                width: 49%;
                height: 48px;
                padding: 8px;
                border: 1px solid #32AAE0;
                font-weight: 700;
                font-size: 12px;
                line-height: 28px;
                text-transform: uppercase;
                color: #FFFFFF;
            }
            .steps_btn_wrapper button.back {
                background-color: #fff;
                color: #32AAE0;
            }
            .steps_btn_wrapper button.continue {
                background-color: #32AAE0;
            }
            .steps_btn_wrapper button.continue:disabled {
                background-color:#C2C2C2;
                border: none;
            }

            /*.shopping-cart-product .product-image {
                min-width: 125px;
                max-width: 125px;
                max-height: 85px;
            }*/

            .checkout-delivery-method, .checkout-payment {padding: 0;}

            .info-section {
                display: flex;
                flex-wrap: wrap;
                position: relative;
            }
            .info-section div:first-child > div {
                display: none !important;
            }
            .info-section-data p:nth-child(4),
            .info-section-data p:nth-child(5),
            .info-section-data p:nth-child(5) + div,
            .info-section-data p:nth-child(5) + div p {
                display: inline !important;
                position: relative;
            }
            .info-section-data p:nth-child(4)::after,
            .info-section-data p:nth-child(5)::after {
                position: absolute;
                content: ',';
                bottom: 0;
                
            }
            .info-section-data p:nth-child(4)::after {
                right: -3px;
            }
            .info-section-data p:nth-child(5)::after {
                right: 1px;
            }


            .change-shipping-info {
                position: absolute;
                top: 20px;
                right: 20px;
            }
            .delivery {width: 100%;}
            .delivery hr {border-color: #C4C4C4;}
            .shipping_title,
            .delivery p {
                font-size: 14px;
                line-height: 22px;
                margin: 0;
            }
            .delivery > div {
                display: flex;
                justify-content: space-between;
            }
            .delivery > div > div {
                display: flex;
            }
            .delivery .method {
                font-weight: 400;            
                color: #000000;            
            }
            .shipping_title,
            .delivery .title {
                font-weight: 600;
                color: #212529;
                width: 150px;
            }
            .delivery .change,
            .change-shipping-info{
                font-weight: 400 !important;   
                color: #32AAE0;
                cursor: pointer;
                font-size: 14px !important;
            }

            .checkout-paypal-btn > div {
                padding: 0 180px;
            }

            app-checkout-payment .checkout-payment {
                width: 49%;
            }

            #paypal-button {
                margin: -10px 0 0;
            }
            .mob_cart_wrapper:not(.clickable) {
                transform: scaleY(0);
                position: absolute;
                pointer-events: none;
                z-index: -1;
            }
            .mob_cart_wrapper {
                background: #FCFCFC;
                display: none;
                padding: 8px 30px;
            }   
            .mob_cart_wrapper  span {
                white-space: nowrap;
            }
            .mob_cart_wrapper.fixed {
                transform-origin: top;
                transition: transform 0.3s ease;
                transform: scaleY(1);
                width: 100%;
                position: fixed;
                top: 0;
                z-index: 2;
                box-shadow: 0 2px 4px rgb(182 182 182 / 75%);
            }
            .mob_cart_wrapper p {
                position: relative;
                display: block;
                font-weight: 600;
                font-size: 16px;
                line-height: 24px;
                color: #212529;
                margin: 0;
            }
            /*.mob_cart_wrapper.clickable p::after{
                position: absolute;
                content: '';
                top: 50%;
                right: 0;
                height: 8px;
                width: 12px;
                background: url('https://conversionratestore.github.io/projects/kingsbox/img/expand_more.svg');
                background-repeat: no-repeat;
                object-fit: cover;
                transform: translateY(-50%) rotate(180deg);
            }  */
            .mob_cart_wrapper.clickable {
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-start;
            }
            .mob_cart_wrapper.clickable .img_wrapper {
                padding: 3px;
                display: flex;
                margin-top: 5px;
                cursor: pointer;
            }
            .mob_cart_wrapper.clickable.hide_cart img{
                transform: rotate(180deg);
            }
            .hide_cart + div {display: none;}
            .hide_cart + div + div {display: none;}

            .product-price p {
                font-weight: 500 !important;
            }

            .shopping-cart-product .product-image {
                min-width: 125px !important;
                max-width: 125px !important;
                height: auto !important;
            }

            .shopping-cart-product>div:last-child {
                margin-top: -1.5rem !important;
            }

            .product-actions i {
                margin-left: 1.5rem !important;
                margin-right: 0 !important;
            }

            @media (min-width: 1640px) {
                .container.container-checkout {
                    max-width: 1580px !important;
                }
            }

            @media (min-width: 1440px) {
                .container.container-checkout {
                    max-width: 1380px !important;
                }
            }
                        
            @media only screen and (min-width: 1200px){
                .product-data {
                width: 100%;
                flex-flow: row !important;
                display: flex !important;
                flex-wrap: wrap !important;
                align-items: baseline !important;
                justify-content: space-between !important;
                }
                .product-data .product-title {
                    width: auto !important;
                    order: 0;
                    white-space: normal !important;
                }
                .product-variations {
                    order: 3;
                    width: 100%;
                }
                .product-price {
                    order: 1;
                }
                .checkout-shipping .moneyback {display: none;}
            }

            @media only screen and (max-width: 1200px) {
                .mob_cart_wrapper {display: flex;}

                .checkout-body {padding-top: 0 !important;}
                .checkout-header-wrapper {position: relative;}

                .checkout-summary,.shopping-cart-product {
                    background-color: #FCFCFC;
                }

                app-product-with-variations .my_title {display: none;}

                .checkout-header, .checkout-header-wrapper {background-color: #000;}
                .checkout-header-wrapper img {filter: invert(100%);}
                .checkout-title {    color: #fff;}

                .container-checkout>div>div>div {
                    display: flex;
                    flex-flow: column;
                }

                .checkout-shipping-info-col+div {
                    order: -1;
                }

                .mob_cart_wrapper, {
                    padding: 8px 30px;
                }
                .checkout-shipping {
                    padding: 30px;
                    border-top: none;
                }
                .moneyback {margin: -30px -30px 0 -30px;}
                .checkout-shopping-cart .moneyback {
                    display: none;
                }
                .checkout-shipping-info-col .moneyback {
                    display: block;
                }
                .moneyback {
                    padding: 8px 30px;
                }
                .moneyback p:first-child {                
                    font-size: 12px;
                }
                .moneyback p:last-child {
                    font-size: 8px;
                }

                .product-actions i {
                    margin-left: 0.8rem !important;
                    margin-right: 0 !important;
                }

                .steps {
                    margin: 24px auto 55px;
                }
                .step p {
                    font-size: 10px;
                }
                .circle {
                    width: 30px;
                    height: 30px;
                }
                .circle::after {
                    font-size: 8px;
                }
                .check .circle::after{ 
                    transform: translate(-50%, -50%) scale(0.5);
                }           

                .total {
                    font-size: .9rem !important;
                }

                app-checkout-payment .checkout-payment {width: 100%;}
                
                .steps_btn_wrapper div {flex-direction: column-reverse; margin-top: 32px;}
                .steps_btn_wrapper button {
                    width: 100%;
                }
                .steps_btn_wrapper button.back {margin-top: 16px;}
                
                .container.container-checkout { padding-bottom: 0px;}

                .checkout-paypal-btn > div {padding: 0; margin: 0;}
                #paypal-button { margin: 0;}
                .mob_widener{padding: 0 25px;}
            }

            @media(min-width: 768px) and (max-width: 1200px){
                .mob_cart_wrapper.fixed {
                    max-width: 800px;
                }
            }

            @media(max-width: 767px) {
                /*.checkout-body {padding-top: 72px;} */
                .mob_cart_wrapper {
                    padding: 8px 20px;
                }
                .shopping-cart-product,
                .checkout-shipping  {
                    padding: 20px;
                }
                .moneyback {
                    margin: -20px -20px 0 -20px;
                }
            }
        </style>
        `;
const waitForEl = selector => {
    return new Promise(resolve => {
        if (document.querySelector(selector)) {
            return resolve(document.querySelector(selector));
        }

        const observer = new MutationObserver(mutations => {
            if (document.querySelector(selector)) {
                resolve(document.querySelector(selector));
                observer.disconnect();
            }

            for (let mutation of mutations) {
                for (let node of mutation.addedNodes) {
                    if (!(node instanceof HTMLElement)) continue;

                    if (node.matches(selector)) {
                        resolve(document.querySelector(selector));
                        observer.disconnect();
                    }
                }
            }
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true,
        });
    });
};
const intervalTimeout = 100;

let device = 'desktop';

if (window.innerWidth < 768) {
    device = 'mobile';
}

const callEvent = (eventAction, eventLabel = '') => {
    // GO Event
    window.dataLayer = window.dataLayer || [];
    const obj = {
        event: 'event-to-ga',
        eventCategory: `Exp: Checkout hypothesis ${device}`,
        eventAction,
        eventLabel,
    };

    dataLayer.push(obj);
    console.log(obj);
};
/** SUMMARY */
document.head.insertAdjacentHTML('beforeend', style);

const moneyback = /*html*/ `
    <div class="moneyback">
        <p>${lang.guaranteeTitle}</p>
        <p>${lang.guaranteeBody}</p>
    </div>
`;
const checkoutSteps = /*html*/ `
            ${moneyback}
            <div class="steps">
                <div class="step black check">
                    <div class="circle"></div>
                    <p>${lang.shop}</p>
                </div>
                <div class="line"></div>
                <div class="step black">
                    <div class="circle" data-number="2"></div>
                    <p>${lang.shipping}</p>
                </div>
                <div class="line mob_widener"></div>
                <div class="step">
                    <div class="circle" data-number="3"></div>
                    <p>${lang.delivery}</p>
                </div>
                <div class="line"></div>
                <div class="step">
                    <div class="circle" data-number="4"></div>
                    <p>${lang.payment}</p>
                </div>
            </div>    
        `;

waitForEl('.checkout-shipping').then(el => {
    el.insertAdjacentHTML('afterbegin', checkoutSteps);
});
waitForEl('.checkout-shipping-info-col').then(el => {
    el.classList.remove('col-xl-4');
    el.classList.add('col-xl-7');
});
waitForEl('.checkout-shipping-info-col + div').then(el => {
    el.classList.remove('col-xl-4');
    el.classList.add('col-xl-5');
});
waitForEl('.checkout-shopping-cart-col').then(el => el.classList.remove('col-xl-4'));
const obsSummary = () => {
    // define an observer instance
    const observer1 = new IntersectionObserver(onIntersection, {
        root: null, // default is the viewport
        threshold: 0.1, // percentage of target's visible area. Triggers "onIntersection"
    });

    // callback is called on intersection change
    function onIntersection(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                document.querySelector('.mob_cart_wrapper:not(.clickable)').classList.remove('fixed');
            } else {
                document.querySelector('.mob_cart_wrapper:not(.clickable)').classList.add('fixed');
            }
        });
    }

    // Use the observer to observe an element
    observer1.observe(document.querySelector('app-checkout-summary'));
};
const changeCartTotalPrice = () => {
    const waitForWr = setInterval(() => {
        if (document.querySelectorAll('.mob_cart_wrapper p span')[1] && document.querySelectorAll('.total')[1]) {
            clearInterval(waitForWr);

            document.querySelectorAll('.mob_cart_wrapper p span').forEach(element => {
                element.innerText = document.querySelectorAll('.total')[1].innerText;
            });
        }
    }, intervalTimeout);
};
const waitForSummaryAndCart = setInterval(() => {
    if (
        document.querySelector('app-checkout-summary') &&
        document.querySelector('.checkout-shopping-cart-col') &&
        document.querySelector('.checkout-summary')
    ) {
        clearInterval(waitForSummaryAndCart);

        document
            .querySelector('app-checkout-summary')
            .insertAdjacentElement('afterbegin', document.querySelector('.checkout-shopping-cart-col')); // put cart above summary

        document
            .querySelector('app-checkout-summary')
            .insertAdjacentHTML(
                'beforebegin',
                `<div class="mob_cart_wrapper"><p>${lang.total} <span></span></p></div>`,
            );
        document.querySelector('app-checkout-summary').insertAdjacentHTML(
            'afterbegin',
            /*html*/ `
            <div class="mob_cart_wrapper clickable">
                <div>
                    <p>${lang.total} <span></span></p>
                </div>
                <div class="img_wrapper">
                    <img src="https://conversionratestore.github.io/projects/kingsbox/img/expand_more.svg" alt="arrow">
                </div>
            </div>
        `,
        );
        waitForEl('.mob_cart_wrapper.clickable .img_wrapper').then(el =>
            el.addEventListener('click', e => {
                el.closest('.mob_cart_wrapper').classList.toggle('hide_cart');
                callEvent('click on cart total arrow');
            }),
        );

        changeCartTotalPrice();

        obsSummary();
    }
}, intervalTimeout);
waitForEl('.checkout-shopping-cart').then(el => el.insertAdjacentHTML('afterbegin', moneyback));
waitForEl('.shopping-cart-product').then(el =>
    el.insertAdjacentHTML('afterbegin', `<h2 class="my_title">${lang.summary}</h2>`),
);
const waitForCoupon = setInterval(() => {
    if (
        document.querySelectorAll('app-checkout-summary div')[2] &&
        document.querySelector('.coupons-form') &&
        document.querySelector('.coupons-form div')
    ) {
        clearInterval(waitForCoupon);

        document.querySelector('.coupons-form div').addEventListener('click', () => {
            document.querySelector('.coupons-form').classList.toggle('opened');
            callEvent('click on promo code/gift card');
        });

        document
            .querySelector('.coupons-form')
            .previousElementSibling.insertAdjacentElement('beforebegin', document.querySelector('.coupons-form'));
    }
}, intervalTimeout);

/** STEPS */
const showStepAndHideOther = stepNumber => {
    if (device === 'desktop') {
        window.scrollTo(0, 0);
    }

    const steps = ['app-checkout-shipping-info', 'app-checkout-delivery-method', 'app-checkout-payment'];

    Promise.all([steps.forEach(item => waitForEl(item).then(el => (el.hidden = true)))]).then(() => {
        if (stepNumber === 0) {
            waitForEl(steps[0] + ' .card-title').then(el => (el.hidden = false));
            waitForEl(steps[0] + ' .shipping_title').then(el => (el.hidden = true));

            if (window.matchMedia('(max-width: 1200px)').matches) {
                waitForEl('.checkout-shipping-info').then(el => (el.hidden = false));
            }
        } else {
            waitForEl(steps[0] + ' .card-title').then(el => (el.hidden = true));
            waitForEl(steps[0] + ' .shipping_title').then(el => (el.hidden = false));

            if (window.matchMedia('(max-width: 1200px)').matches) {
                waitForEl('.checkout-shipping-info').then(el => (el.hidden = true));
            }
        }

        if (stepNumber === 1 || stepNumber === 2) {
            waitForEl(steps[0]).then(el => (el.hidden = false));
            waitForEl(steps[0] + ' .card-title').then(el => (el.hidden = true));
        }

        if (stepNumber === 2) {
            waitForEl('.delivery').then(el => (el.hidden = false));
        } else {
            waitForEl('.delivery').then(el => (el.hidden = true));
        }
        waitForEl(steps[stepNumber]).then(el => (el.hidden = false));
    });

    const waitForStepBar = setInterval(() => {
        if (document.querySelectorAll('.steps .step')[3]) {
            clearInterval(waitForStepBar);

            document.querySelectorAll('.steps .step:not(:first-child)').forEach((step, index) => {
                if (stepNumber === index) {
                    step.classList.add('black');
                } else if (stepNumber < index) {
                    step.classList.remove('black', 'check');
                } else {
                    step.classList.add('check');
                }
            });
        }
    }, intervalTimeout);

    const waitForBtns = setInterval(() => {
        if (document.querySelectorAll('.steps_btn_wrapper button')[5]) {
            clearInterval(waitForBtns);

            document.querySelectorAll('.steps_btn_wrapper div').forEach((div, index) => {
                if (index === stepNumber) {
                    div.hidden = false;
                } else {
                    div.hidden = true;
                }
            });
        }
    }, intervalTimeout);

    waitForEl('.info-section-data')
        .then(() => waitForEl('[data-stepbtn="shipping"] .continue'))
        .then(el => el.removeAttribute('disabled'));

    // sessionStorage.setItem('checkout_step', stepNumber);
};

const waitForBtns = setInterval(() => {
    if (document.querySelectorAll('.steps_btn_wrapper button')[5]) {
        clearInterval(waitForBtns);

        document.querySelector('.steps_btn_wrapper').addEventListener('click', e => {
            if (e.target.matches('button')) {
                callEvent(`click on button — ${e.target.innerText}`);
            }
        });
    }
}, intervalTimeout);

// if (sessionStorage.getItem('checkout_step')) {
//     switch (sessionStorage.getItem('checkout_step')) {
//         case '0':
//             showStepAndHideOther(0);
//             break;
//         case '1':
//             showStepAndHideOther(1);
//             break;
//         case '2':
//             showStepAndHideOther(2);
//             break;

//         default:
//             break;
//     }
// } else {
//     showStepAndHideOther(0);
// }

showStepAndHideOther(0)

waitForEl('.checkout-shipping').then(el => {
    el.insertAdjacentHTML(
        'beforeend',
        /*html*/ `
        <div class="steps_btn_wrapper">
            <div data-stepBtn="shipping">
                <button class="back" onclick="location.href='https://kingsbox.com/'" type="button">${lang.backShop}</button>
                <button class="continue" onclick="showStepAndHideOther(1)" disabled>${lang.continueDelivery}</button>
            </div>
            <div data-stepBtn="delivery">
                <button class="back" onclick="showStepAndHideOther(0)">${lang.backShipping}</button>
                <button class="continue" onclick="showStepAndHideOther(2)" disabled>${lang.continuePayment}</button>
            </div>
            <div data-stepBtn="pay">
                <button class="back" onclick="showStepAndHideOther(1)" type="button">${lang.backDelivery}</button>
                <button class="continue" disabled>${lang.pay}</button>
            </div>
        </div>`,
    );
});
waitForEl('.info-section-data').then(el => {
    el.insertAdjacentHTML('beforebegin', `<p class="shipping_title">${lang.shipping}</p>`);

    el.insertAdjacentHTML(
        'afterend',
        /*html*/ `
            <div class="delivery">
                <hr>
                <div>
                    <div>
                        <p class="title">${lang.delivery}&nbsp;</p>                   
                        <p class="method"><span data-delivery="method"></span><span data-delivery="price"></span></p>
                    </div>
                    <p class="change" onclick="showStepAndHideOther(1)">${lang.change}</p>
                </div>         
            </div>
        `,
    );
});
const changeDeliveryPriceAndBtn = () => {
    waitForEl('div.d-flex.flex-row.justify-content-between.align-items-center.mb-4.ng-tns-c106-7 p:last-child').then(
        price => {
            waitForEl('[data-stepBtn="delivery"] .continue').then(btn => {
                if (price.innerText !== '/' && price.innerText !== lang.calculated) {
                    btn.removeAttribute('disabled');

                    const waitForEl = setInterval(() => {
                        if (
                            (document.querySelector('.active .value') || document.querySelector('.active h6')) &&
                            document.querySelector('[data-delivery="method"]') &&
                            document.querySelector('[data-delivery="price"]') &&
                            price
                        ) {
                            clearInterval(waitForEl);

                            document.querySelector('[data-delivery="method"]').innerText =
                                (document.querySelector('.active .value')?.innerText ||
                                    document.querySelector('.active h6')?.innerText) + ' — ';

                            document.querySelector('[data-delivery="price"]').innerText = price.innerText;
                        }
                    }, intervalTimeout);
                } else {
                    price.innerText = lang.calculated;
                    btn.setAttribute('disabled', true);
                }
            });
        },
    );
    changeCartTotalPrice();
};
waitForEl('.checkout-summary').then(el => {
    changeDeliveryPriceAndBtn();

    const target = el;
    const config = {
        childList: true,
        subtree: true,
    };
    let observer = new MutationObserver(mutations => {
        for (let mutation of mutations) {
            for (let node of mutation.addedNodes) {
                if (!(node instanceof HTMLElement)) continue;

                if (node.matches('.item-price')) {
                    changeDeliveryPriceAndBtn();
                }
            }
        }
    });
    observer.observe(target, config);
});
const waitForPay = setInterval(() => {
    if (document.querySelector('.checkout-submit') && document.querySelector('[data-stepBtn="pay"] .continue')) {
        clearInterval(waitForPay);

        document.querySelector('[data-stepBtn="pay"] .continue').hidden = false;

        document.querySelector('[data-stepBtn="pay"] .continue').onclick = () => {
            document.querySelector('.checkout-submit-btn').click();
        };

        const target = document.querySelector('.checkout-submit');
        const config = {
            childList: true,
            subtree: true,
            attributes: true,
        };
        let observer = new MutationObserver(mutations => {
            for (let mutation of mutations) {
                for (let node of mutation.addedNodes) {
                    if (!(node instanceof HTMLElement)) continue;

                    if (node.matches('.checkout-paypal-btn')) {
                        document
                            .querySelector('[data-stepBtn="pay"] .continue')
                            .insertAdjacentElement('afterend', document.querySelector('#paypal-button'));
                        document.querySelector('[data-stepBtn="pay"] .continue').hidden = true;
                    }
                    if (node.matches('.checkout-submit-btn')) {
                        document.querySelector('[data-stepBtn="pay"] .continue').hidden = false;
                        document.querySelector('[data-stepBtn="pay"] .continue').onclick = () => {
                            document.querySelector('.checkout-submit-btn').click();
                        };
                    }
                }
            }
        });
        observer.observe(target, config);
    }
}, 100);
const waitForPayBtn = setInterval(() => {
    if (document.querySelector('.checkout-payment') && document.querySelector('[data-stepbtn="pay"] .continue')) {
        clearInterval(waitForPayBtn);

        document.querySelector('.checkout-payment').addEventListener(
            'click',
            e => {
                if (e.target.closest('.payment-method-wrapper')) {
                    document.querySelector('[data-stepbtn="pay"] .continue').removeAttribute('disabled');
                }
            },
            { once: true },
        );
    }
}, intervalTimeout);

if(language === 'en') {
    waitForEl('.checkout-delivery-method .description .value').then(el => {
        el.innerHTML = 'Some items in your cart aren’t available at the moment. Firstly, we will ship everything in stock. As soon as other options become available we will ship them too.'
    })
}

callEvent('loaded');

const record = setInterval(() => {
    if (typeof clarity === 'function') {
        clearInterval(record);

        clarity('set', `checkout_hypothesis_${device}`, 'variant_1');
    }
}, intervalTimeout);

waitForEl('.checkout-empty-container').then(() => {
    callEvent('cart is empty');
});